# å¼‚æ­¥ç¼–ç¨‹

> * äº‹ä»¶å¾ªç¯ & éé˜»å¡I/O éƒ½æ˜¯ LIBUVï¼ˆc++ åº“ï¼‰æä¾›çš„èƒ½åŠ›ï¼Œå…±åŒå®Œæˆäº† Node.js çš„å¼‚æ­¥æ“ä½œï¼›
> * äº‹ä»¶å¾ªç¯æ˜¯éé˜»å¡ I/O çš„åŸºç¡€ï¼›
> * ç†è§£äº† äº‹ä»¶å¾ªç¯ & éé˜»å¡ I/O å°±ç†è§£äº† Node.js çš„å¼‚æ­¥æ˜¯æ€æ ·è¿è¡Œçš„ï¼›

# 1ã€â™¨ï¸éé˜»å¡I/O

## 1.1ã€concept

- I/O å³ Input/Output,ä¸€ä¸ªç³»ç»Ÿçš„è€Œè¾“å…¥å’Œè¾“å‡ºï¼›
- é˜»å¡ I/O å’Œéé˜»å¡ I/O çš„åŒºåˆ«å°±åœ¨äº**ç³»ç»Ÿæ¥æ”¶è¾“å…¥å†åˆ°è¾“å‡ºçš„æ—¶é—´ï¼Œèƒ½ä¸èƒ½æ¥æ”¶å…¶ä»–è¾“å…¥**ï¼›
- ç†è§£éé˜»å¡I/Oï¼š
  - ç¡®å®š **ç³»ç»Ÿï¼Œè¾“å…¥ï¼Œè¾“å‡º**ï¼Œåˆ†åˆ«æ˜¯ä»€ä¹ˆ
  - åœ¨ I/O è¿‡ç¨‹ä¸­ï¼Œ èƒ½ä¸èƒ½è¿›è¡Œå…¶ä»–I/O

## 1.2ã€case

- ç³»ç»Ÿ = é£Ÿå ‚é˜¿å§¨ & æœåŠ¡ç”Ÿ
  - é£Ÿå ‚é˜¿å§¨åªèƒ½ä¸€ä»½ä»½åœ°æ‰“é¥­ -> é˜»å¡ I/O
  - æœåŠ¡ç”Ÿç‚¹å®Œèœåè¿˜å¯ä»¥æœåŠ¡å…¶ä»–å®¢äºº  -> éé˜»å¡ I/O
- è¾“å…¥ = ç‚¹èœ
- è¾“å‡º = ç«¯èœ

## 1.3ã€code

> é˜»å¡I/O

```js
const glob = require('glob')

var result = null;
console.time('glob');
result = glob.sync(__dirname + '/**/*')						// è·å–ç›®ä¸‹çš„æ–‡ä»¶å’Œæ–‡ä»¶å
console.log('got result');
console.timeEnd('glob');

// got result
// glob:30.607ms
```

> éé˜»å¡I/O

```js
const glob = require('glob')

var result = null;
console.time('glob');
glob(__dirname + '/**/*', function (err, res) {		// è·å–ç›®ä¸‹çš„æ–‡ä»¶å’Œæ–‡ä»¶å
    result = res;
    console.log('got result');
})
console.timeEnd('glob');
console.log(1 + 1);

// glob: 3.198ms
// 2
// got result
```

## 1.4ã€Node.js æ¶æ„å›¾ä¸­ç†è§£éé˜»å¡ I/O 

> å·¦è¾¹ Node.js çº¿ç¨‹ï¼Œé€šè¿‡è°ƒåŠ¨å³ä¾§çš„å…¶å®ƒ c++ çº¿ç¨‹çš„æ–¹å¼ï¼Œå®ç°éé˜»å¡ I/Oï¼›

* å·¦è¾¹ Node.js çº¿ç¨‹ä¸­ï¼ŒAPPLICATION ç›¸å½“äºé¡¾å®¢ï¼Œå…¶å®ƒçš„å†…å®¹ç›¸å½“äºç‚¹é¤æœåŠ¡å‘˜ï¼›
  * ç‚¹é¤çš„æœåŠ¡äººå‘˜æ”¶åˆ°èœå•åï¼Œäº¤ç»™åå¨ï¼Œå¯ä»¥ç»§ç»­æœåŠ¡å…¶å®ƒé¡¾å®¢ç‚¹èœï¼›
* å³è¾¹å…¶å®ƒ c++ çº¿ç¨‹ç›¸å½“äºåå¨ï¼›

<img class="picture" src="https://cdn.nlark.com/yuque/0/2021/png/114317/1623206384912-assets/web-upload/b2d4078e-4755-4ec0-90ee-69250cd74980.png" alt="" style="width: 880px; height: 382px;">

# 2ã€callback

> â™¨ï¸éé˜»å¡I/Oçš„è¿è¡Œç»“æœæ˜¯éœ€è¦å›è°ƒå‡½æ•°æ¥æ¥æ”¶çš„ï¼Œè¿™ç§é€šè¿‡å›è°ƒå‡½æ•°çš„æ–¹å¼å°±æ˜¯å¼‚æ­¥ç¼–ç¨‹ï¼

## 2.1ã€å›è°ƒå‡½æ•°æ ¼å¼è§„èŒƒ

* **Node.js è§„å®šç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯erroï¼Œç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯ç»“æœï¼å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°ä¸ä¸ºç©ºï¼Œåˆ™è¯´æ˜å¼‚æ­¥è°ƒç”¨å‡ºé”™äº†ï¼**
  * error-first callbak
  * Node-style callback
  * ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ errorï¼Œåé¢çš„å‚æ•°æ‰æ˜¯ç»“æœ

## 2.2ã€å¼‚æ­¥æµç¨‹æ§åˆ¶é—®é¢˜

* å›è°ƒåœ°ç‹±

# 3ã€â™¨ï¸äº‹ä»¶å¾ªç¯

* âš ï¸åœ¨ node å½“ä¸­ï¼Œå®ä»»åŠ¡é˜Ÿåˆ—å’Œå¾®ä»»åŠ¡é˜Ÿåˆ—éƒ½åªæ˜¯æ¦‚å¿µï¼Œæ²¡æœ‰è¯´å“ªä¸ªå…·ä½“é˜Ÿåˆ—åå­—å°±å«åšå®ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ­£ç¡®çš„è®¤çŸ¥åº”è¯¥æ˜¯å‰é¢æˆ‘ä»¬ä¸‹é¢è¯´çš„äº‹ä»¶å¾ªç¯å½“ä¸­çš„6ä¸ªé˜¶æ®µå¯¹åº”çš„6ä¸ªåŸºæœ¬çš„é˜Ÿåˆ—éƒ½å±äºå®é˜Ÿåˆ—ï¼›
* âš ï¸æœ‰ä¸€ä¸ªç‰¹åˆ«å®¹æ˜“æ··æ·†çš„ç‰ˆæœ¬æ”¹å˜ï¼š
  - å¦‚æœæ˜¯node10åŠå…¶ä¹‹å‰ç‰ˆæœ¬ï¼š
    - å®é˜Ÿåˆ—å½“ä¸­çš„æœ‰å‡ ä¸ªå®ä»»åŠ¡ï¼Œæ˜¯è¦ç­‰åˆ°å®é˜Ÿåˆ—å½“ä¸­çš„æ‰€æœ‰å®ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œæ¯•æ‰ä¼šå»æ‰§è¡Œå¾®é˜Ÿåˆ—å½“ä¸­çš„å¾®ä»»åŠ¡ã€‚
  - å¦‚æœæ˜¯node11ç‰ˆæœ¬ï¼š
    - ä¸€æ—¦æ‰§è¡Œä¸€ä¸ªé˜¶æ®µé‡Œå¯¹åº”å®é˜Ÿåˆ—å½“ä¸­çš„ä¸€ä¸ªå®ä»»åŠ¡(setTimeout,setIntervalå’ŒsetImmediateä¸‰è€…å…¶ä¸­ä¹‹ä¸€ï¼Œä¸åŒ…æ‹¬I/O)å°±ç«‹åˆ»æ‰§è¡Œå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ‰§è¡Œå®Œå¾®é˜Ÿåˆ—å½“ä¸­çš„æ‰€æœ‰å¾®ä»»åŠ¡å†å›åˆ°åˆšæ‰çš„å®é˜Ÿåˆ—æ‰§è¡Œä¸‹ä¸€ä¸ªå®ä»»åŠ¡ã€‚è¿™å°±è·Ÿæµè§ˆå™¨ç«¯è¿è¡Œä¸€è‡´äº†ã€‚

1. jsæ‰§è¡Œä¸ºå•çº¿ç¨‹ï¼Œæ‰€æœ‰ä»£ç çš†åœ¨ä¸»çº¿ç¨‹è°ƒç”¨æ ˆå®Œæˆæ‰§è¡Œï¼Œå½“ä¸»çº¿ç¨‹ä»»åŠ¡æ¸…ç©ºåæ‰ä¼šå»è½®è¯¢å–ä»»åŠ¡é˜Ÿåˆ—ä¸­ä»»åŠ¡ï¼›

2. åœ¨nodeä¸­äº‹ä»¶**æ¯ä¸€è½®**å¾ªç¯æŒ‰ç…§**é¡ºåº**åˆ†ä¸º6ä¸ªé˜¶æ®µï¼Œæ¥è‡ªlibuvçš„å®ç°ï¼š
   1. timersã€Timers Queueã€‘ï¼šæ‰§è¡Œæ»¡è¶³æ¡ä»¶çš„setTimeoutã€setIntervalå›è°ƒã€‚
   2. I/O callbacksã€I/O Queueã€‘ï¼šæ˜¯å¦æœ‰å·²å®Œæˆçš„I/Oæ“ä½œçš„å›è°ƒå‡½æ•°ï¼Œæ¥è‡ªä¸Šä¸€è½®çš„pollæ®‹ç•™ã€‚
   3. idleï¼Œprepareï¼šå¯å¿½ç•¥
   4. pollï¼šç­‰å¾…è¿˜æ²¡å®Œæˆçš„I/Oäº‹ä»¶ï¼Œä¼šå› timerså’Œè¶…æ—¶æ—¶é—´ç­‰ç»“æŸç­‰å¾…ã€‚
   5. checkã€Check Queueã€‘ï¼šæ‰§è¡ŒsetImmediateçš„å›è°ƒã€‚
   6. close callbacksã€Close Queueã€‘ï¼šå…³é—­æ‰€æœ‰çš„closing handlesï¼Œä¸€äº›oncloseäº‹ä»¶ã€‚
3. process.nextTick å‡½æ•°ï¼š
   1. ç‹¬ç«‹äº `Event Loop` ä¹‹å¤–çš„ï¼Œå®ƒæœ‰ä¸€ä¸ªè‡ªå·±çš„é˜Ÿåˆ—ï¼›
   2. å½“æ¯ä¸ªé˜¶æ®µå®Œæˆåï¼Œå¦‚æœå­˜åœ¨`nextTick`é˜Ÿåˆ—ï¼Œå°±ä¼šæ¸…ç©ºé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å›è°ƒå‡½æ•°ï¼Œå¹¶ä¸”ä¼˜å…ˆäºå…¶ä»– `microtask` æ‰§è¡Œã€‚

# 4ã€â™¨ï¸promise

## 4.1ã€concept

>  Promise æ˜¯ä¸€ç§å¼‚æ­¥ç¼–ç¨‹çš„è§£å†³æ–¹æ¡ˆï¼Œè§£å†³äº†ä¸Šè¿°å¼‚æ­¥æµç¨‹æ§åˆ¶çš„å›è°ƒåœ°ç‹±é—®é¢˜ï¼

1. å½“å‰ **äº‹ä»¶å¾ªç¯** å¾—ä¸åˆ°çš„ç»“æœï¼Œä½†æœªæ¥çš„ **äº‹ä»¶å¾ªç¯** ä¼šç»™åˆ°ä½ ç»“æœï¼›
2. æ˜¯ä¸€ä¸ªçŠ¶æ€æœºï¼špending åªèƒ½æµè½¬åˆ° resolve æˆ–è€… rejectï¼Œresolve å’Œ reject ä¸èƒ½äº’ç›¸æµè½¬ï¼›
   * pending
   * fulfilled/resolved
   * rejected
3. .then & .catch 

- - resolved çŠ¶æ€çš„ Promise ä¼šå›è°ƒåé¢çš„ç¬¬ä¸€ä¸ª .thenï¼›
  - rejected çŠ¶æ€çš„ Promise ä¼šå›è°ƒåé¢çš„ç¬¬ä¸€ä¸ª .catchï¼›
    - ä»»ä½•ä¸€ä¸ª rejected çŠ¶æ€åé¢æ²¡æœ‰ .catch çš„ Promise ï¼Œéƒ½ä¼šé€ æˆ Jsç¯å¢ƒçš„å…¨å±€é”™è¯¯ï¼›

4. æ‰§è¡Œ then å’Œ catch ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Promiseï¼Œè¯¥ Promise æœ€ç»ˆçŠ¶æ€æ ¹æ® then å’Œ catch çš„å›è°ƒå‡½æ•°çš„æ‰§è¡Œç»“æœå†³å®šï¼š
   * å¦‚æœå›è°ƒå‡½æ•°æœ€ç»ˆç»“æœæ˜¯ throwï¼Œåˆ™è¯¥ Promise æ˜¯ rejected çŠ¶æ€ï¼›
   * å¦‚æœå›è°ƒå‡½æ•°æœ€ç»ˆç»“æœæ˜¯ returnï¼Œåˆ™è¯¥ Promise æ˜¯ resolved çŠ¶æ€ï¼›
   * å¦‚æœå›è°ƒå‡½æ•°æœ€ç»ˆ return äº†ä¸€ä¸ªæ–° Promise ï¼Œåˆ™è¯¥è€ Promise ä¼šå’Œå›è°ƒå‡½æ•° return çš„æ–° Promise çŠ¶æ€ä¿æŒä¸€è‡´ï¼›
     * è¿™ç§ Promise çš„é“¾å¼è°ƒç”¨ä¸­ï¼Œå¯ä»¥ä¸²è¡Œçš„æ‰§è¡Œå¤šä¸ªå¼‚æ­¥ä»»åŠ¡ï¼›
5. Promise.all([promise1, promise2]) æ¥å—ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„ä¸­å¯ä»¥åŒ…å«å¤šä¸ª promise ï¼›
   * æ•°ç»„ä¸­æ‰€æœ‰çš„ promise çŠ¶æ€éƒ½ä¸º resolved æ—¶ï¼Œä¼šå›è°ƒåé¢çš„ç¬¬ä¸€ä¸ª .thenï¼›
   * æ•°ç»„ä¸­æ‰€æœ‰çš„ promise çŠ¶æ€éƒ½ä¸º rejected æ—¶ï¼Œä¼šå›è°ƒåé¢çš„ç¬¬ä¸€ä¸ª .catchï¼›

## 4.2ã€code

1. promise çš„çŠ¶æ€è½¬æ¢ä»¥åŠé€šè¿‡ then / catch è·å–å†…å®¹

   ```js
   const promise = new Promise((resolve, reject) => {
     	// resolve(3);
       setTimeout(function () {
           reject(new Error(4))
       }, 500)
   })
   
   promise
       // .then(function (result) {
       //     console.log(result)		// <resolved> 3
       // })
       .catch(function (err) {
           return 1
       })
   
   setTimeout(() => {
       console.log(promise);					// <rejected> Error: 4
   }, 800)
   ```

2. promise çš„é“¾å¼è°ƒç”¨

   ```js
   // ä¸²è¡Œçš„æ‰§è¡Œå¤šä¸ªå¼‚æ­¥ä»»åŠ¡
   interview(1)
       .then(()=> {
           return interview(2);
       })
       .then(()=> {
           return interview(3);
       })
       .then(()=> {
           console.log('smile')
       })
       .catch((err)=> {
           console.log('cry at ' + err.round)
       })
   
   function interview(round) {
       return new Promise((resolve, reject) => {
           setTimeout(()=> {
               if (Math.random() < 0.2) {
                   const error = new Error('failed');
                   error.round = round;
                   reject(error);
       
               } else {
                   resolve('success');
               }
           }, 500)
       })
   }
   ```

3. Promise.all å®Œæˆå¼‚æ­¥å¹¶è¡Œä»»åŠ¡

   ```js
   Promise
       .all([interview('tencent'), interview('alibaba')])
       .then(() => {
           console.log('smile');
       })
       .catch((err) => {
           console.log('cry for ' + err.name)
       })
   
   
   function interview(name) {
       return new Promise((resolve, reject) => {
           setTimeout(() => {
               if (Math.random() < 0.2) {
                   const error = new Error('failed');
                   error.name = name;
                   reject(error);
   
               } else {
                   resolve('success');
               }
           }, 500)
       })
   }
   ```

# 5ã€â™¨ï¸async/await

> * ğŸ‘‡ä»£ç ä¸­ï¼Œâ€œäº‹ä»¶å¾ªç¯â€ é˜»ç¢äº† `throw new Error('fail')` å’Œ `catch` ï¼›
>
> ```js
> function interview(callback) {
>     setTimeout(() => {
>         if (Math.random() < 0.3) {
>             callback('success');
>         }
>         throw new Error('fail')
> 
>     }, 1000);
> }
> 
> try {
>     interview(function (res) {
>         if (res === 'success') {
>             console.log('ğŸ˜Š')
>         }
>     })
> } catch (error) {
>     console.log('ğŸ˜­', error);
> }
> ```
>
> ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ` try catch `å¹¶ä¸èƒ½æ•è· ` throw new Error('fail')`  æŠ›å‡ºçš„é”™è¯¯ï¼,è€Œæ˜¯æŠ›å‡ºåˆ°äº†JSå…¨å±€ï¼
>
> ä¸ºä»€ä¹ˆæ²¡ `try catch`  æ— æ³•æ•è· setTimeout é‡Œé¢çš„ `throw` å‘¢ï¼Ÿ è¿™å°±è·Ÿ**è°ƒç”¨æ ˆ** å’Œ **äº‹ä»¶å¾ªç¯**æœ‰å…³ç³»äº†!
>
> **æ¯ä¸€ä¸ªäº‹ä»¶å¾ªç¯éƒ½æ˜¯ä¸€ä¸ªå…¨æ–°çš„è°ƒç”¨æ ˆ!**  **`setTimeout`** **ä¸  interview æ˜¯ä¸¤ä¸ªä¸åŒçš„äº‹ä»¶å¾ªç¯ï¼** æ‰€ä»¥ catch æ— æ³•æ•æ‰é”™è¯¯ï¼›
>
> * æœ¬èŠ‚ async/await æ˜¯ç©¿è¶Š â€œäº‹ä»¶å¾ªç¯â€ çš„ function ï¼›

## 5.1ã€async function æ˜¯ Promise çš„è¯­æ³•ç³–

1. fulfilled çŠ¶æ€

```js
const a = async function () {
    return 1;
}

const b = function () {
    return new Promise((resolve, reject) => {
        resolve(1)
    })
}

console.log(a());			// PromiseÂ {<fulfilled>: 1}
console.log(b());			// PromiseÂ {<fulfilled>: 1}
```

2. rejected çŠ¶æ€

```js
const aa = async function () {
    throw new Error('1');
}

const bb = function () {
    return new Promise((resolve, reject) => {
        reject(new Error('1'))
    })
}

console.log(aa());		// PromiseÂ {<rejected>: Error: 1
console.log(bb());		// PromiseÂ {<rejected>: Error: 1
```

## 5.2ã€å¼‚æ­¥ç¼–ç¨‹çš„ç»ˆæè§£å†³æ–¹æ¡ˆï¼šä»¥åŒæ­¥çš„æ–¹å¼å†™å¼‚æ­¥

1. await å…³é”®å­—å¯ä»¥"æš‚åœâ¸"  async function çš„æ‰§è¡Œï¼›

   * await å°† resolve æ‹¬å·ä¸­çš„ç»“æœä»˜å€¼ç»™ contentï¼Œæ¥ä¸‹æ¥çš„ä»£ç å¯ä»¥è·å¾— content çš„å€¼ï¼›

   * è¾¾åˆ°äº†å¯ä»¥åŒæ­¥è·å– Promise æ‰§è¡Œç»“æœçš„æ•ˆæœï¼›

   ```js
   (function () {
       const result = async function () {
         	// await ä¼šç­‰å¾… åé¢ Promise çŠ¶æ€å˜æ›´ï¼Œå¹¶å°†è·å¾—çš„ç»“æœä»˜å€¼ç»™ content ï¼Œ content è·å¾—ç»“æœåï¼Œæ‰ä¼šæ‰§è¡Œä¸‹ä¸€è¡Œä»£ç ï¼›
           const content = await new Promise((resolve, reject) => {
               setTimeout(() => {
                   resolve('!!!!!!')
               }, 5000);
           })
   
           console.log('content', content);
           return 4;
       }()
   
       setTimeout(() => {
           console.log('result', result);
       }, 8000);
   })()
   
   // 5s å
   // content !!!!!!
   
   // 8s å
   // result PromiseÂ {<fulfilled>: 4}
   ```

2. try catch å¯ä»¥æ•è· await çš„é”™è¯¯ï¼›

   * await åçš„ Promise è‹¥æ˜¯ rejected ï¼Œè¢« catch æ•æ‰åï¼Œä¸ä¼šå°† reject æ‹¬å·ä¸­çš„å€¼ä»˜ç»™ content ï¼›

   ```js
   (function () {
       const result = async function () {
           let content = null;
           try {
               content = await new Promise((resolve, reject) => {
                   setTimeout(() => {
                       reject(new Error('fail'))
                   }, 500);
               })
           } catch (error) {
               console.log('error', error);
           }
   
   
           console.log('content', content);
           return 4;
       }()
   
       setTimeout(() => {
           console.log('result', result);
       }, 800);
   })()
   
   // error Error: fail
   // content null
   // result PromiseÂ {<fulfilled>: 4}
   ```

## 5.3ã€code

1. promise çš„é“¾å¼è°ƒç”¨ï¼Œä½¿ç”¨ await ç²¾ç®€ä»£ç æ”¹é€ 

   ```js
   (async function() {
       try {
           await interview(1);
           await interview(2);
           await interview(3);
       } catch (err) {
           return console.log("ç¬¬ " + err.round + " è½®é¢è¯•å¤±è´¥ï¼");
       }
   
       console.log("é€šè¿‡æ‰€æœ‰é¢è¯•ï¼")
   })()
   
   
   function interview(round) {
       return new Promise((resolve, reject) => {
           setTimeout(()=> {
               if (Math.random() < 0.2) {
                   const error = new Error('failed');
                   error.round = round;
                   reject(error);
       
               } else {
                   resolve('success');
               }
           }, 500)
       })
   }
   ```

2. Promise.all å®Œæˆå¼‚æ­¥å¹¶è¡Œä»»åŠ¡ï¼Œä½¿ç”¨ await ç²¾ç®€ä»£ç æ”¹é€ 

   ```js
   (async function() {
       try {
           await Promise.all(
               [interview('tencent'), interview('huawei'), interview('alibaba')]
           )
       } catch (err) {
           return console.log(err.name + " é¢è¯•å¤±è´¥ï¼")
       }
   
       console.log("æ‰€æœ‰é¢è¯•å…¨éƒ¨é€šè¿‡ï¼")
   })()
   
   function interview(name) {
       return new Promise((resolve, reject) => {
           setTimeout(() => {
               if (Math.random() < 0.2) {
                   const error = new Error('failed');
                   error.name = name;
                   reject(error);
   
               } else {
                   resolve('success');
               }
           }, 500)
       })
   }
   ```

   

